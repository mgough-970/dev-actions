name: Deprecate Notebook

on:
  workflow_call:
    inputs:
      notebook-path:
        description: "Path to the notebook to deprecate (e.g., notebooks/MIRI/JWPipeNB-MIRI-MRS.ipynb)"
        required: true
        type: string
      removal-date:
        description: "Scheduled removal date (e.g., 2024-12-31)"
        required: true
        type: string
    secrets:
      github-token:
        required: true

jobs:
  deprecate-notebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add Deprecation Banner and Metadata
        run: |
          NOTEBOOK="${{ inputs.notebook-path }}"
          REMOVAL_DATE="${{ inputs.removal-date }}"

          echo "Deprecating notebook: $NOTEBOOK with removal date: $REMOVAL_DATE"

          if [[ ! -f "$NOTEBOOK" ]]; then
            echo "ERROR: Notebook not found at $NOTEBOOK"
            exit 1
          fi

          # Insert a Markdown warning cell at the top
          jq --arg date "$REMOVAL_DATE" \
            '.cells |= [{"cell_type":"markdown","metadata":{},"source":["⚠️ **DEPRECATED**: This notebook is scheduled for removal on \($date).\n"]}] + .' \
            "$NOTEBOOK" > temp1.json && mv temp1.json "$NOTEBOOK"

          # Add deprecation metadata
          jq '.metadata.deprecated = {"status": true, "removal_date": "'"$REMOVAL_DATE"'"}' "$NOTEBOOK" > temp2.json && mv temp2.json "$NOTEBOOK"

      - name: Commit and Push Deprecation Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout gh-storage || git checkout -b gh-storage
          git add "${{ inputs.notebook-path }}"
          git commit -m "Manually deprecated notebook ${{ inputs.notebook-path }}"
          git push origin gh-storage
        env:
          GITHUB_TOKEN: ${{ secrets.github-token }}
